library(pascPhen)
data(rules)
force(rules)
View(rules)
utils::data(rules)
utils::data(rules)
force(rules)
View(rules)
#devtools::install_github("rebeccamesa/pascPhen")
#devtools::install_github("hestiri/mlho")
library(pascPhen)
library(mlho)
if(!require(pacman)) install.packages("pacman")
pacman::p_load(data.table, devtools, backports, Hmisc, tidyr,dplyr,ggplot2,plyr,scales,readr,Rmisc,
httr, DT, lubridate, tidyverse,reshape2,foreach,doParallel,caret,gbm,lubridate,praznik,
ggridges, forcats, stats)
knitr::opts_chunk$set(
collapse = TRUE,
echo = TRUE,
comment = "#>"
)
PatientObservations <- read.csv(file.choose())
setwd("C:/Users/rebim/Desktop/Tesi/PASC Analysis/Rule based Phenotyping/pascPhen")
PatientObservations <- read.csv(file.choose())
PatientSummary<- read.csv(file.choose())
data("rules")
View(PatientObservations)
phen_distribution(PatientObservations, PatientSummary, rules)
data("lincoln_weather")
force(lincoln_weather)
View(lincoln_weather)
PatientObservations <- dplyr::select(PatientObservations, -value,-siteid)
data <- PatientSummary %>%
dplyr::select(patient_num, sex, admission_date) %>%
merge(PatientObservations, by = "patient_num")
data$calendar_date <- as.Date(data$admission_date)+data$days_since_admission
data <- data %>%
dplyr::mutate(stage = dplyr::case_when(days_since_admission > 90 ~ "long",
days_since_admission > 30 ~ "post",
days_since_admission > -14 ~ "acute",
TRUE ~ 'pre'))%>%
dplyr::select(c(1,2,3,4,7,8,5,6)) %>%
dplyr::mutate(stage = factor(stage, levels = c("pre", "acute", "post", "long")))
# Compute occurences
phenotypes <- unique(rules$PASC_Phenotype)
tot.count <- data.frame()
Phen.data.tot <- data.frame()
for (i in 1:length(phenotypes)) {
Phen.rules <- dplyr::filter(rules, PASC_Phenotype == phenotypes[i])
Phen.data <- data[paste(gsub(".*-", "", data$concept_type), data$concept_code) %in% paste(Phen.rules$Coding, Phen.rules$Code),]
counts <- table(dplyr::select(Phen.data,stage))
if (sum(counts)>0) {
tot.count<-rbind(tot.count,c(phenotypes[i], counts))
Phen.data$phenotype <- paste(phenotypes[i])
Phen.data.tot<-rbind(Phen.data.tot, Phen.data)
}
}
names(tot.count)<- c("Phenotype", "pre", "acute", "post", "long")
View(Phen.data.tot)
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal() +
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
#ggplot2::theme_minimal() +
viridis::scale_fill_viridis()+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
#ggplot2::theme_minimal() +
ggplot2::scale_fill_brewer()+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
#ggplot2::theme_minimal() +
ggplot2::scale_fill_binned()+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stage)) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
#ggplot2::theme_minimal() +
ggplot2::scale_fill_binned()+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stage)) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
#ggplot2::theme_minimal() +
ggplot2::scale_fill_brewer()+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stage)) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal() +
ggplot2::scale_fill_brewer()+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal() +
viridis::scale_fill_viridis()+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1<-ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal() +
ggplot2::scale_fill_viridis_c()+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal() +
ggplot2::scale_fill_viridis_c()+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal() +
ggplot2::scale_fill_viridis_c()+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1<-ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal() +
ggplot2::scale_fill_viridis_b()+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal() +
ggplot2::scale_fill_viridis_b()+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal() +
ggplot2::scale_fill_viridis_c(option = "C")+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1<-ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal() +
ggplot2::scale_fill_viridis_c(option = "C")+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1+ facet_wrap(~sex)
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
#ggplot2::theme_minimal() +
ggplot2::scale_fill_viridis_c(option = "C")+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1<-ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
#ggplot2::theme_minimal() +
ggplot2::scale_fill_viridis_c(option = "C")+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1+ facet_wrap(~sex)
pl1
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_light()+
ggplot2::scale_fill_viridis_c(option = "C")+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1<-ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_classic()+
ggplot2::scale_fill_viridis_c(option = "C")+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1
pl1<-ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_linedraw()+
ggplot2::scale_fill_viridis_c(option = "C")+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1
pl1<-ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_grey()+
ggplot2::scale_fill_viridis_c(option = "C")+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1
pl1<-ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(option = "C")+
ggplot2::theme(legend.position = "none") +
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1
pl1++ facet_wrap(~sex)+theme_grey()
pl1+facet_wrap(~sex)+theme_grey()
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission",option = "C")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1<-ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "C")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1+facet_wrap(~sex)
pl1+facet_wrap(~sex)+theme_grey()
stratified_by <- "sex"
pl1<-ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "C")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
if(!is.null(stratified_by)){
pl1<-pl1+
ggplot2::facet_wrap(~Phen.data.tot[,stratified_by])+
ggplot2::theme_grey()
}
pl1
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "D")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "A")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "B")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "E")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "F")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "G")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "H")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "I")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "J")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "L")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "G")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
pl1<-ggplot2::ggplot(Phen.data.tot, aes(y = forcats::fct_rev(forcats::fct_infreq(phenotype)), x = as.numeric(days_since_admission), fill = stat(x))) +
ggridges::geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, alpha = 0.9) +
ggplot2::theme_minimal()+
ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "G")+
ggplot2::labs(x = "Days since admission", y = "", title = "Phenotype distribution")
if(!is.null(stratified_by)){
pl1<-pl1+
ggplot2::facet_wrap(~Phen.data.tot[,stratified_by])+
ggplot2::theme_grey()
}
pl1
devtools::load_all()
phen_distribution(PatientObservations, PatientSummary, rules)
data("rules")
View(rules)
PatientObservations <- read.csv(file.choose())
PatientSummary<- read.csv(file.choose())
data("rules")
phen_distribution(PatientObservations, PatientSummary, rules)
phen_distribution(PatientObservations, PatientSummary, rules, stratified_by = "sex")
phen_distribution(PatientObservations, PatientSummary, rules, stratified_by = "sex")
phen_distribution(PatientObservations, PatientSummary, rules)
