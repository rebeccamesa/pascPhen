---
title: "PascPhen Report"
output: 
  html_document: 
    highlight: tango
    toc: yes
---


```{r, echo=FALSE, include=FALSE}
library(pascPhen)
library(mlho)
if(!require(pacman)) install.packages("pacman")
pacman::p_load(data.table, devtools, backports, Hmisc, tidyr,dplyr,ggplot2,plyr,scales,readr,Rmisc,
               httr, DT, lubridate, tidyverse,reshape2,foreach,doParallel,caret,gbm,lubridate,praznik,
               ggridges, forcats, stats, FourCePhase2.1Data)
```
*This report is generated from  `r siteid` 4Ce data 2.1 on `r Sys.Date()`.* 

## Exploring the PASC phenotypes

### Distribution of phenotypes by first record
The figure below represents the distribution of the phenotypes over the five 4CE stages

```{r, echo=FALSE, error=FALSE,fig.align='center', fig.width= 10}
distribution.output <- runAnalysis_distribution (data_dir, siteid, long.thres)
tot.count<-distribution.output$tot.count
tot.count.long <- pivot_longer(tot.count[-nrow(tot.count),], -c(site, Phenotype), values_to = "Count", names_to = "Stage")
tot.count.plot <- tot.count.long %>%mutate(Stage = factor(Stage, levels = c("day90plus", "day30to89", "day0to29", "dayN14toN1", "before_adm")))

ggplot2::ggplot(tot.count.plot,
                aes(x = forcats::fct_rev(Phenotype), y = Count, fill = Stage))+
  ggplot2::geom_bar(stat = "identity")+
  ggplot2::theme_minimal()+
  ggplot2::coord_flip()+
  ggplot2::scale_fill_brewer(name = "Stage:", labels = c("day90plus", "day30to89", "day0to29", "dayN14toN1", "before_adm"))+
  ggplot2::labs(y = "Counts", x = "",
                title = "Phenotype counts",
                subtitle = siteid)

```


### Phenotypes to model
From the initial list, you can pursue phenotyping the following PASC phenotypes.

```{r, echo=FALSE, fig.align='center', fig.width= 10}
phen.prev <- subset(distribution.output$post.prev, perc >=long.perc*100)
phen.prev <- phen.prev[order(phen.prev$perc, decreasing = TRUE),]
datatable(phen.prev, options = list(pageLength = 5), filter = 'bottom')

```
The table presents the `r nrow(phen.prev)` phenotypes for which we have x positives, where x>=`r long.perc` of the total patients with available data from `r long.thres` days or longer after hospitalization/infection

## Applying MLHO to perform PheWAS 
```{r, echo=FALSE, fig.align='center', fig.width= 10, warning=FALSE, error=FALSE, message=FALSE}
PASClist <- phen.prev$phenotype
phen.data.plot <- distribution.output$phen.data%>%
                            dplyr::filter(phenotype %in% PASClist)

ggplot2::ggplot(phen.data.plot, aes(y = forcats::fct_rev(phenotype), x = as.numeric(days_since_admission), fill = stat(x))) +
  ggridges::geom_density_ridges_gradient(scale = 2, rel_min_height = 0.01, alpha = 0.8) +
  ggplot2::theme_minimal()+
  ggplot2::scale_fill_viridis_c(name = "Days since admission:",option = "G")+
  ggplot2::labs(x = "Days since admission", y = "",
                title = "Phenotype distribution",
                subtitle = siteid)

mlho_list<- list()

# create for loop to produce the tables of new features and report rocs
for (i in seq_along(PASClist)) { 
  tryCatch({
    print(paste0("running MLHO for ",PASClist[i]))
    # run MLHO on each phenotype
    mlho_list[[i]] <- runAnalysis_MLHO(data_dir, siteid, long.thres, MSMR.sparsity, phenotype = PASClist[i])
    
  },
  error = function(fr) {cat("ERROR :",conditionMessage(fr), "\n")})
}
datatable( do.call(rbind, lapply(mlho_list, data.frame, stringsAsFactors=FALSE)),
           options = list(pageLength = 30), filter = 'bottom')

```


## info
Ask questions pr report issues: `rebecca.mesa01@universitadipavia.it`

